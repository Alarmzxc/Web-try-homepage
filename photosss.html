<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarm图集</title>
  <link rel="icon" href="./image/favicon.ico" />
  <style>
    :root{
      --bg: rgba(11, 18, 32, 0.98);
      --card: rgba(15, 23, 42, 0.85);
      --muted: rgba(148, 163, 184, 0.8);
      --text: #e5e7eb;
      --primary: #60a5fa;
      --primary-2: #a78bfa;
      --ring: rgba(148,163,184,.25);
      --shadow: 0 10px 30px rgba(2,6,23,.35);
      --radius: 16px;
      --transition-default: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    [data-theme="light"] .brand h1 {
      background: linear-gradient(135deg, #1e293b 0%, #334155 30%, #475569 65%, #64748b 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    [data-theme="light"] {
      --bg: rgba(241, 245, 249, 0.98);
      --card: rgba(255,255,255,0.85);
      --muted: rgba(100, 116, 139, 0.8);
      --text: #1e293b;
      --primary: #3b82f6;
      --primary-2: #8b5cf6;
      --ring: rgba(148,163,184,.15);
      --shadow: 0 10px 30px rgba(2,6,23,.1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html {
      height: 100%;
      background: var(--bg);
    }

    body {
      min-height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", sans-serif;
      color: var(--text);
      background: transparent;
      transition: var(--transition-default);
      opacity: 0;
      animation: pageFadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      animation-delay: 0.2s;
    }
    
    @keyframes pageFadeIn {
      to {
        opacity: 1;
      }
    }

    .container{max-width:1200px;margin:0 auto;padding:24px 20px 60px}

    /* 顶部英雄区 */
    header.hero{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      margin:0 0 12px 0;
      padding:12px 0 8px 0;
      min-height:22vh;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{
      width:32px;
      height:32px;
      border-radius:8px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      box-shadow:var(--shadow);
      transition: var(--transition-default);
      opacity: 0;
      animation: scaleIn 0.6s cubic-bezier(0.18, 1.25, 0.4, 1) forwards;
      animation-delay: 0.3s;
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:1px;
      line-height:1.1;
      background:linear-gradient(135deg,#fff 0%, #dbeafe 30%, #e9d5ff 65%, #fff 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      transition: var(--transition-default);
      opacity: 0;
      animation: slideUpFade 0.7s cubic-bezier(0.18, 1.25, 0.4, 1) forwards;
      animation-delay: 0.4s;
    }
    
    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      transition: var(--transition-default);
      opacity: 0;
      animation: slideUpFade 0.7s ease forwards;
      animation-delay: 0.5s;
    }

    /* 控件区 */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .hero-bar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 32px;
      padding: 12px 0 8px 0;
      min-height: 12vh;
    }
    .hero-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      min-width: 260px;
    }
    .hero-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      flex: 1;
    }
    .controls-row {
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      max-width: 800px;
      opacity: 0;
      animation: slideUpFade 0.7s ease forwards;
      animation-delay: 0.6s;
    }
    .file-btn {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      justify-self: center;
    }
    .btn {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      justify-self: center;
    }
    /* 搜索框：图标和输入框同一行 */
    .input {
      display: flex;
      align-items: center;
      flex: 1 1 0;
      min-width: 300px;
      max-width: 700px;
      margin-right: 10px;
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(15,23,42,.6);
      backdrop-filter: blur(10px);
      border: 1px solid var(--ring);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      gap: 8px;
      transition: var(--transition-default);
    }
    .input:focus-within {
      background: rgba(15,23,42,.8);
      box-shadow: 0 0 0 2px var(--primary);
    }
    .input svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      color: var(--muted);
      transition: var(--transition-default);
    }
    .input input {
      all: unset;
      color: var(--text);
      width: 100%;
      font-size: 15px;
      padding-left: 4px;
      transition: var(--transition-default);
    }
    .btn, .file-btn{
      appearance:none;border:none;cursor:pointer;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      background:linear-gradient(135deg, rgba(96,165,250,.2), rgba(167,139,250,.2));
      backdrop-filter: blur(4px);
      color:var(--text);border:1px solid var(--ring);
      transition:var(--transition-default);
    }
    .btn:hover,.file-btn:hover{
      transform:translateY(-2px);
      background: linear-gradient(135deg, rgba(96,165,250,.3), rgba(167,139,250,.3));
      box-shadow:var(--shadow);
    }
    .btn:active,.file-btn:active{transform:translateY(0)}
    
    /* 主题切换按钮 */
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,.7);
      backdrop-filter: blur(4px);
      border: 1px solid var(--ring);
      color: var(--text);
      font-size: 24px;
      width: 44px;
      height: 44px;
      transition: var(--transition-default);
      transform: rotate(0deg);
    }
    .theme-toggle:hover {
      transform: rotate(15deg);
    }
    [data-theme="light"] .theme-toggle {
      background: rgba(255,255,255,.7);
    }


    /* 分类chips */
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:2px;
    }
    .chip{
      padding:8px 12px;
      font-size:13px;
      border-radius:6px;
      border:1px solid var(--ring);
      color:var(--muted);
      background:rgba(15,23,42,.6);
      backdrop-filter: blur(4px);
      cursor:pointer;
      user-select:none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    [data-theme="light"] .chip {
      background: rgba(255,255,255,.6);
      color: var(--muted);
    }

    /* 悬停效果 */
    .chip:hover {
      background: rgba(96,165,250,.15);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(2,6,23,0.15);
    }

    /* 选中状态 */
    .chip.active{
      background:linear-gradient(135deg, rgba(96,165,250,.25), rgba(167,139,250,.25));
      border-color:rgba(99,102,241,.5);
      color:#fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(2,6,23,0.2);
    }



    /* 提示/告警 */
    .banner{
      display:none;
      margin:14px auto 0;
      max-width:860px;
      padding:8px 10px;
      border-radius:8px;
      border:1px dashed rgba(248,113,113,.5);
      background:rgba(239,68,68,.1);
      color:#fecaca;
      font-size:12px;
      margin-top:8px;
      transition: var(--transition-default);
    }

    /* 网格 */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(330px,1fr));
      gap:20px;
      margin-top:22px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    .grid.loaded {
      opacity: 1;
      transform: translateY(0);
    }
    .card {
      position: relative;
      margin-bottom: 20px;
      transition: transform 0.5s cubic-bezier(.4,2,.3,1), box-shadow 0.5s ease;
      border-radius: 12px;
      overflow: hidden;
      background: var(--card);
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      animation: cardAppear 0.6s cubic-bezier(0.18, 1.25, 0.4, 1) forwards;
    }
    
    @keyframes cardAppear {
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.4);
    }
    .thumb {
      width: 100%;
      height: 0;
      padding-bottom: 62%;
      position: relative;
      background: #ffffff00;
      overflow: hidden;
    }
    .thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.05);
      transition: transform .35s ease;
    }
    .card-info {
      padding: 12px 16px;
      transition: var(--transition-default);
    }
    .card-title {
      font-size: 15px;
      margin: 0 0 4px 0;
      color: var(--text);
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .card-category {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    /* 预览层 */
    .lightbox{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(3,6,23,.9);
      backdrop-filter:blur(12px);
      z-index:50;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .lightbox.open{
      display:flex;
      opacity: 1;
    }
    [data-theme="light"] .lightbox { 
      background: rgba(241,245,249,0.95); 
    }
    .lb-inner{
      max-width:95vw;
      max-height:95vh;
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .lb-img-container{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .lb-img{
      max-width:90vw;
      max-height:80vh;
      border-radius:16px;
      box-shadow:var(--shadow);
      transform: scale(0.95);
      transition: transform 0.5s cubic-bezier(0.18, 1.25, 0.4, 1);
    }
    .lightbox.open .lb-img {
      transform: scale(1);
    }
    .lb-cap{
      color:#e5e7eb;
      text-align:center;
      margin-top:10px;
      font-size:14px;
      max-width:600px;
      padding:0 20px;
      transition: var(--transition-default);
    }
    [data-theme="light"] .lb-cap { 
      color: #1e293b; 
    }
    .lb-close{
      position:absolute;
      top:20px;
      right:20px;
      display: flex;
      gap: 10px;
    }
    /* 下载按钮 */
    .lb-download {
      position: absolute;
      top: 20px;
      right: 70px;
      background: rgba(15,23,42,.7);
      backdrop-filter: blur(4px);
      border: 1px solid var(--ring);
      color: #fff;
      border-radius: 12px;
      padding: 12px 14px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition-default);
    }
    [data-theme="light"] .lb-download {
      background: rgba(255,255,255,.7);
      color: #1e293b;
    }
    .lb-download:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    /* 修改导航按钮布局 */
    .lb-nav{
      position: absolute;
      top: 50%;
      left: -70px;
      right: auto;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      pointer-events: none;
    }
    .lb-nav.right{
      left: auto;
      right: -70px;
    }
    .lb-nav button{pointer-events:auto;}
    .icon-btn{
      background:rgba(15,23,42,.7);
      backdrop-filter: blur(4px);
      border:1px solid var(--ring);
      color:#fff;
      border-radius:12px;
      padding:12px 14px;
      cursor:pointer;
      font-size:16px;
      margin:0;
      transition: var(--transition-default);
    }
    [data-theme="light"] .icon-btn { 
      background: rgba(255,255,255,.7); 
      color: #1e293b; 
    }
    .icon-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    /* 响应式调整 */
    @media (max-width:640px){
      .brand h1{font-size:34px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
      .icon-btn{padding:10px 12px;margin:0 10px;}
      .lb-nav, .lb-nav.right { 
        left: 0; 
        right: 0; 
        flex-direction: row; 
        gap: 0; 
        top: auto; 
        bottom: -50px; 
        transform: none; 
        justify-content: space-between; 
        width: 100%; 
      }
      .lb-download {
        top: 10px;
        right: 60px;
        padding: 8px 10px;
        font-size: 14px;
      }
    }

    /* 分页样式 */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      margin: 32px 0 0 0;
      background: rgba(255,255,255,0);
      border-radius: 24px;
      padding: 16px 0;
      box-shadow: 0 2px 12px rgba(2,6,23,0.08);
      transition: var(--transition-default);
    }
    [data-theme="light"] .pagination {
      background: rgba(255,255,255,0);
      box-shadow: 0 2px 12px rgba(96,165,250,0.08);
    }

    .page-btn {
      min-width: 48px;
      height: 48px;
      font-size: 1.1em;
      border-radius: 50%;
      border: none;
      background: #fff;
      color: #1e293b;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(96,165,250,0.08);
      transition: all 0.3s cubic-bezier(0.18, 1.25, 0.4, 1);
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
    }
    .page-btn[disabled], .page-btn.active {
      background: #d1d5db;
      color: #334155;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(96,165,250,0.18);
    }
    .page-btn:hover:not([disabled]) {
      background: #bae6fd;
      color: #2563eb;
      transform: translateY(-2px) scale(1.05);
    }
    .ellipsis {
      padding: 0 8px;
      color: #64748b;
      font-size: 1em;
      user-select: none;
    }

    /* 深色主题下的搜索框 */
    .input {
      background: rgba(15,23,42,.6);
      color: var(--text);
      border: 1px solid var(--ring);
    }

    /* 浅色主题下的搜索框 */
    [data-theme="light"] .input {
      background: rgba(255,255,255,.6);
      color: #1e293b;
      border: 1px solid var(--ring);
    }
    [data-theme="light"] .input input {
      color: #1e293b;
    }
    [data-theme="light"] .input svg {
      color: #64748b;
    }
    
    /* 手机端适配 */
    @media (max-width: 640px) {
      .hero-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        min-height: unset;
        padding: 8px 0 4px 0;
      }
      .hero-left, .hero-right {
        align-items: stretch;
        min-width: unset;
        gap: 6px;
      }
      .controls-row {
        flex-direction: column;
        gap: 8px;
        max-width: 100%;
        align-items: stretch;
        justify-content: flex-start;
      }
      .input {
        min-width: 0;
        max-width: 100%;
        font-size: 16px;
        padding: 10px 12px;
      }
      .input svg {
        width: 20px;
        height: 20px;
      }
      .theme-toggle {
        width: 40px;
        height: 40px;
        font-size: 22px;
        padding: 8px;
      }
      .chips {
        justify-content: flex-start;
        gap: 4px;
        margin-top: 4px;
        overflow-x: auto;
        padding-bottom: 8px;
        scrollbar-width: none;
      }
      .chips::-webkit-scrollbar {
        display: none;
      }
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .card {
        margin-bottom: 20px;
      }
      .thumb {
        border-radius: 8px;
      }
      .thumb img {
        border-radius: 8px;
      }
      .card-info {
        padding: 10px 12px;
      }
      .card-title {
        font-size: 14px;
      }
      .card-category {
        font-size: 11px;
      }
      /* 预览层箭头移动到底部左右两侧 */
      .lb-nav, .lb-nav.right {
        position: absolute;
        top: auto;
        bottom: 16px;
        left: 0;
        right: 0;
        flex-direction: row;
        gap: 0;
        justify-content: space-between;
        width: 100%;
        transform: none;
      }
      .icon-btn {
        padding: 10px 12px;
        font-size: 18px;
        margin: 0 10px;
        border-radius: 10px;
      }
    }

    /* 预览层关闭和下载按钮始终固定在右上角，所有屏幕都可见 */
.lightbox.open .lb-close {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 100;
  background: none;
  flex-direction: row;
  gap: 10px;
}
.lightbox.open .lb-download {
  position: fixed;
  top: 24px;
  right: 90px;
  z-index: 100;
}
@media (max-width: 640px) {
  .lightbox.open .lb-close {
    top: 12px;
    right: 12px;
    gap: 8px;
  }
  .lightbox.open .lb-download {
    top: 12px;
    right: 70px;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <header class="hero-bar" aria-label="页头">
      <div class="hero-left">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Alarm图集</h1>
        </div>
        <div class="sub">
          自动按 <code>category</code> 分类｜从 <strong><a href="./photos.json">photos.json</a></strong> 读取（支持多种 JSON 结构）
        </div>
        <div class="controls-row">
          <label class="file-btn">选择你自己的本地 JSON
            <input id="file" type="file" accept="application/json,.json" hidden>
          </label>
          <button class="btn" id="export">导出当前JSON</button>
        </div>
      </div>
      <div class="hero-right">
        <div class="controls-row">
          <div class="input" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            <input id="q" placeholder="搜索标题 / 分类…" autocomplete="off" />
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="切换主题">🌓</button>
        </div>
        <div class="chips" id="chips" aria-label="分类"></div>
      </div>
      <div class="banner" id="banner">未能通过 <code>fetch('photos.json')</code> 读取数据。若在本地直接用 <code>file://</code> 打开，将被浏览器拦截。解决：① 使用本地服务器（如 VSCode Live Server / <code>python -m http.server</code>）；或 ② 点击"选择本地 JSON"手动加载；或 ③ 部署到静态托管（如 Cloudflare Pages）。</div>
    </header>

    <main>
      <section class="grid" id="grid" aria-live="polite"></section>
    </main>
  </div>

  <!-- 预览 -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <div class="lb-inner">
      <div class="lb-close">
        <button class="icon-btn" id="close" aria-label="关闭">✕</button>
        <button class="lb-download" id="download" aria-label="下载图片">⬇️下载图片</button>
      </div>
      <div class="lb-nav">
        <button class="icon-btn" id="prev" aria-label="上一张">◀</button>
      </div>
      <div class="lb-img-container">
        <img id="lbImg" class="lb-img" alt="预览图" />
      </div>
      <div class="lb-nav right">
        <button class="icon-btn" id="next" aria-label="下一张">▶</button>
      </div>
      <div id="lbCap" class="lb-cap"></div>
    </div>
  </div>

  <script>
    // ---------------- 主题切换功能 ----------------
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    let currentTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      currentTheme = theme;
    }
    
    // 初始化主题
    setTheme(currentTheme);
    
    themeToggle.addEventListener('click', () => {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    // ---------------- 数据加载与标准化 ----------------
    /**
     * 目标标准结构：
     * [ { category: string, photos: [{ url, caption }] } ]
     * 兼容以下输入：
     *  1) 与目标相同结构
     *  2) 扁平数组：[{category, url|avatar|src, caption|name|title}]
     *  3) 单对象：{category, avatar|url, name|caption}
     */
    function normalize(input){
      if(!input) return [];

      // 如果是单对象
      if(!Array.isArray(input)){
        const url = input.url || input.avatar || input.src;
        const caption = input.caption || input.name || input.title || '';
        const category = input.category || '未分类';
        return [{ category, photos: [{ url, caption }] }];
      }

      // 如果是数组且每项含 photos 数组
      if(Array.isArray(input) && input.length && input[0] && Array.isArray(input[0].photos)){
        // 简单校验 url
        return input.map(g => ({
          category: g.category || g.title || '未分类',
          photos: (g.photos||[]).map(p=>({ url: p.url || p.avatar || p.src, caption: p.caption || p.name || p.title || '' }))
        }));
      }

      // 如果是扁平数组
      if(Array.isArray(input)){
        const map = new Map();
        for(const item of input){
          const url = item.url || item.avatar || item.src;
          if(!url) continue;
          const caption = item.caption || item.name || item.title || '';
          const category = item.category || '未分类';
          if(!map.has(category)) map.set(category, []);
          map.get(category).push({ url, caption });
        }
        return [...map.entries()].map(([category, photos])=>({category, photos}));
      }
      return [];
    }

    // 旧页面数据（作为兜底 & 导出示例）
    const OLD_PHOTO_GROUPS = [
      { title: "雨水", photos: [
        { url: "https://i.imgs.ovh/2025/04/29/r7Sux.png", caption: "垂钓" },
        { url: "https://placekitten.com/406/300", caption: "小猫1" },
        { url: "https://placekitten.com/407/300", caption: "小猫2" }
      ]},
      { title: "第一人称", photos: [
        { url: "https://i.imgs.ovh/2025/05/29/TxhIr.png", caption: "1" },
        { url: "https://i.imgs.ovh/2025/05/29/TxI9M.png", caption: "2" }
      ]}
    ];

    function oldToStandard(groups){
      return groups.map(g=>({ category: g.category || g.title || '未分类', photos: g.photos.map(p=>({url:p.url, caption:p.caption||''})) }));
    }

    // ---------------- 渲染与交互 ----------------
    const state = {
      data: [],            // 标准化后的数据（所有分类）
      flat: [],            // 扁平化后的所有图片项 {url, caption, category}
      filterCat: '全部',   // 当前分类
      q: '',               // 搜索词
      visible: [],          // 当前渲染顺序（用于预览导航）
      page: 1              // 当前页码
    };

    const els = {
      banner: document.getElementById('banner'),
      chips: document.getElementById('chips'),
      grid: document.getElementById('grid'),
      q: document.getElementById('q'),
      file: document.getElementById('file'),
      exportBtn: document.getElementById('export'),
      lb: document.getElementById('lightbox'),
      lbImg: document.getElementById('lbImg'),
      lbCap: document.getElementById('lbCap'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      close: document.getElementById('close'),
      download: document.getElementById('download')
    };

    async function tryFetchJson(){
      try{
        const res = await fetch('photos.json?ts=' + Date.now());
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        return json;
      }catch(e){
        els.banner.style.display = 'block';
        return null;
      }
    }

    function buildFlat(data){
      const flat = [];
      for(const g of data){
        for(const p of g.photos){
          if(!p || !p.url) continue;
          flat.push({ url: p.url, caption: p.caption || '', category: g.category });
        }
      }
      return flat;
    }

    function uniqueCats(data){
      const set = new Set();
      data.forEach(g=> set.add(g.category||'未分类'));
      return ['全部', ...[...set].sort((a,b)=>a.localeCompare(b,'zh'))];
    }

    function renderChips(){
      // 如果已经渲染过，只更新活动状态
      if(els.chips.children.length > 0) {
        const chips = els.chips.querySelectorAll('.chip');
        chips.forEach(chip => {
          chip.classList.toggle('active', chip.textContent === state.filterCat);
        });
        return;
      }
      
      // 首次渲染
      els.chips.innerHTML = '';
      const cats = uniqueCats(state.data);
      
      cats.forEach((cat, index) => {
        const b = document.createElement('button');
        b.className = 'chip' + (cat === state.filterCat ? ' active': '');
        b.textContent = cat;
        b.onclick = ()=>{ 
          state.filterCat = cat; 
          state.page = 1;
          
          // 更新活动状态
          const chips = els.chips.querySelectorAll('.chip');
          chips.forEach(chip => {
            chip.classList.toggle('active', chip.textContent === cat);
          });
          
          // 重新渲染网格
          els.grid.classList.remove('loaded');
          setTimeout(() => {
            renderGrid();
            setTimeout(() => els.grid.classList.add('loaded'), 50);
          }, 300);
        };
        els.chips.appendChild(b);
      });
    }

    // 图片懒加载（IntersectionObserver）
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const img = entry.target; 
          img.src = img.dataset.src; 
          io.unobserve(img);
        }
      })
    }, { rootMargin: '200px' });

    const PAGE_SIZE = 20;
    state.page = 1;

    function renderGrid(){
      const q = state.q.trim().toLowerCase();
      const shuffled = [...state.flat].sort(() => Math.random() - 0.5);
      const list = shuffled.filter(item=>{
        const passCat = state.filterCat === '全部' || item.category === state.filterCat;
        const passQ = !q || (item.caption && item.caption.toLowerCase().includes(q)) || (item.category && item.category.toLowerCase().includes(q));
        return passCat && passQ;
      });
      state.visible = list;
      // 分页
      const start = (state.page - 1) * PAGE_SIZE;
      const pageItems = list.slice(start, start + PAGE_SIZE);
      els.grid.innerHTML='';
      
      pageItems.forEach((item, index) => {
        const card = document.createElement('article');
        card.className = 'card'; 
        card.setAttribute('tabindex','0');
        card.style.animationDelay = `${index * 0.05}s`;
        
        const thumb = document.createElement('div'); 
        thumb.className = 'thumb';
        
        const img = document.createElement('img'); 
        img.alt = item.caption || '壁纸'; 
        img.loading = 'lazy'; 
        img.decoding='async'; 
        img.dataset.src = item.url; 
        io.observe(img);
        
        thumb.appendChild(img);
        
        const cardInfo = document.createElement('div');
        cardInfo.className = 'card-info';
        
        const title = document.createElement('h3');
        title.className = 'card-title';
        title.textContent = item.caption || '';
        
        const category = document.createElement('p');
        category.className = 'card-category';
        category.textContent = item.category || '';
        
        cardInfo.appendChild(title);
        cardInfo.appendChild(category);
        
        card.appendChild(thumb); 
        card.appendChild(cardInfo);
        
        card.onclick = ()=> openLightbox(start + index);
        card.onkeydown = (e)=>{ if(e.key==='Enter') openLightbox(start + index); };
        
        els.grid.appendChild(card);
      });
      
      renderPagination(list.length);
      
      // 触发重排以确保动画生效
      setTimeout(() => {
        els.grid.classList.add('loaded');
      }, 50);
    }

    function renderPagination(total){
      const totalPages = Math.ceil(total / PAGE_SIZE);
      let html = '';

      // ⬅按钮
      html += `<button class="page-btn" ${state.page===1?'disabled':''} data-page="${state.page-1}">⬅</button>`;

      // 页码显示逻辑
      if (totalPages <= 7) {
        // 页码少时全部显示
        for(let i=1;i<=totalPages;i++){
          html += `<button class="page-btn" ${i===state.page?'active':''} data-page="${i}">${i}</button>`;
        }
      } else {
        // 页码多时显示部分，省略号隐藏中间页码
        if (state.page > 3) {
          html += `<button class="page-btn" data-page="1">1</button>`;
          if (state.page > 4) html += `<span class="ellipsis">...</span>`;
        }
        // 当前页前后各显示2个
        let start = Math.max(2, state.page - 2);
        let end = Math.min(totalPages - 1, state.page + 2);
        for(let i=start;i<=end;i++){
          html += `<button class="page-btn" ${i===state.page?'active':''} data-page="${i}">${i}</button>`;
        }
        if (state.page < totalPages - 2) {
          if (state.page < totalPages - 3) html += `<span class="ellipsis">...</span>`;
          html += `<button class="page-btn" data-page="${totalPages}">${totalPages}</button>`;
        }
      }

      // 下一页按钮
      html += `<button class="page-btn" ${state.page===totalPages?'disabled':''} data-page="${state.page+1}">⮕</button>`;

      if(!els.pagination){
        els.pagination = document.createElement('div');
        els.pagination.className = 'pagination';
        els.grid.parentNode.appendChild(els.pagination);
      }
      els.pagination.innerHTML = html;
      els.pagination.onclick = e=>{
        if(e.target.dataset.page){
          const page = Number(e.target.dataset.page);
          if(page >= 1 && page <= totalPages && page !== state.page){
            state.page = page;
            els.grid.classList.remove('loaded');
            setTimeout(() => {
              renderGrid();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 300);
          }
        }
      };
    }

    function openLightbox(idx){
      const it = state.visible[idx]; if(!it) return;
      els.lb.classList.add('open');
      els.lbImg.src = it.url; 
      els.lbCap.textContent = it.caption || '';
      els.lb.dataset.idx = String(idx);
      els.lb.dataset.url = it.url; // 存储当前图片URL用于下载
    }
    
    function closeLightbox(){ 
      els.lb.classList.remove('open'); 
      els.lbImg.src=''; 
    }
    
    function nav(delta){
      const idx = Number(els.lb.dataset.idx||0) + delta;
      if(idx<0 || idx>=state.visible.length) return;
      els.lb.dataset.idx = String(idx);
      const it = state.visible[idx];
      els.lbImg.src = it.url; 
      els.lbCap.textContent = it.caption || '';
      els.lb.dataset.url = it.url; // 更新下载URL
    }

    // 事件绑定
    els.q.addEventListener('input', ()=>{ 
      state.q = els.q.value; 
      state.page = 1;
      els.grid.classList.remove('loaded');
      setTimeout(() => {
        renderGrid();
      }, 300);
    });
    
    els.file.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{ 
        try{ 
          const json = JSON.parse(fr.result); 
          applyData(json); 
        } catch(err){ 
          alert('JSON 解析失败'); 
        } 
      };
      fr.readAsText(file);
    });
    
    els.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = 'photos.json'; 
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });

    // Lightbox 控制
    els.close.onclick = closeLightbox;
    els.prev.onclick = ()=> nav(-1);
    els.next.onclick = ()=> nav(1);
    els.download.onclick = () => {
      const url = els.lb.dataset.url;
      if (url) {
        window.open(url, '_blank');
      }
    };
    
    document.addEventListener('keydown', (e)=>{
      if(!document.getElementById('lightbox').classList.contains('open')) return;
      if(e.key==='Escape') closeLightbox();
      if(e.key==='ArrowLeft') nav(-1);
      if(e.key==='ArrowRight') nav(1);
    });
    
    document.getElementById('lightbox').addEventListener('click', (e)=>{ 
      if(e.target.id==='lightbox') closeLightbox(); 
    });

    function applyData(raw){
      const norm = normalize(raw);
      state.data = norm;
      state.flat = buildFlat(state.data);
      state.filterCat = '全部'; 
      state.q='';
      state.page = 1;
      
      // 先隐藏网格，然后渲染内容，最后显示带动画
      els.grid.classList.remove('loaded');
      setTimeout(() => {
        renderChips(); 
        renderGrid();
      }, 300);
    }

    // 启动：优先读取 photos.json，失败则回退到旧数据
    (async function init(){
      const json = await tryFetchJson();
      if(json){ 
        applyData(json); 
      }
      else{ 
        applyData(oldToStandard(OLD_PHOTO_GROUPS)); 
      }
    })();
  </script>
</body>
</html>