<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarm图集</title>
  <link rel="icon" href="./image/favicon.ico" />
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #60a5fa;
      --primary-2: #a78bfa;
      --ring: rgba(148,163,184,.35);
      --shadow: 0 10px 30px rgba(2,6,23,.35);
      --radius: 16px;
    }
    [data-theme="light"] .brand h1 {
      background: linear-gradient(135deg, #1e293b 0%, #334155 30%, #475569 65%, #64748b 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    [data-theme="light"] {
      --bg: #f1f5f9;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #3b82f6;
      --primary-2: #8b5cf6;
      --ring: rgba(148,163,184,.2);
      --shadow: 0 10px 30px rgba(2,6,23,.1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 0% -10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(900px 400px at 100% 20%, rgba(167,139,250,.2), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      min-height:100%;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .container{max-width:1200px;margin:0 auto;padding:24px 20px 60px}

    /* 顶部英雄区 */
    header.hero{display:flex;flex-direction:column;gap:18px;align-items:center;margin:10px 0 24px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--primary-2));box-shadow:var(--shadow)}
    .brand h1{margin:0;font-size:42px;letter-spacing:1px;line-height:1.1;background:linear-gradient(135deg,#fff 0%, #dbeafe 30%, #e9d5ff 65%, #fff 100%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:14px}

    /* 控件区 */
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;}
    .input{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      background:rgba(15,23,42,.7);
      border:1px solid var(--ring);
      min-width:260px;max-width:360px;width:100%;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    [data-theme="light"] .input {
      background:rgba(255,255,255,.7);
    }
    .input input{all:unset;color:var(--text);width:100%;font-size:14px}
    .btn, .file-btn{
      appearance:none;border:none;cursor:pointer;
      padding:10px 14px;border-radius:12px;font-size:14px;
      background:linear-gradient(135deg, rgba(96,165,250,.15), rgba(167,139,250,.15));
      color:var(--text);border:1px solid var(--ring);
      transition:transform .15s ease, background .2s ease, box-shadow .2s ease;
    }
    .btn:hover,.file-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:active,.file-btn:active{transform:translateY(0)}
    
    /* 主题切换按钮 */
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,.7);
      border: 1px solid var(--ring);
      color: var(--text);
    }
    [data-theme="light"] .theme-toggle {
      background: rgba(255,255,255,.7);
    }

    /* 分类chips */
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);color:var(--muted);background:rgba(15,23,42,.6);font-size:13px;cursor:pointer;user-select:none}
    [data-theme="light"] .chip {
      background: rgba(255,255,255,.6);
      color: var(--muted);
    }
    .chip.active{background:linear-gradient(135deg, rgba(96,165,250,.25), rgba(167,139,250,.25));border-color:rgba(99,102,241,.5);color:#fff}

    /* 提示/告警 */
    .banner{display:none;margin:14px auto 0;max-width:860px;padding:12px 14px;border-radius:12px;border:1px dashed rgba(248,113,113,.5);background:rgba(239,68,68,.1);color:#fecaca;font-size:13px}

    /* 网格 */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));gap:20px;margin-top:22px}
    .card{position:relative;background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .thumb{width:100%;height:0;padding-bottom:62%; /* 16:10 */ display:block;position:relative;background:#111}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05);transition:transform .35s ease}
    .card:hover .thumb img{transform:scale(1.06)}
    .cap{position:relative;padding:12px;color:var(--text);font-size:14px;background:var(--card);border-top:1px solid var(--ring)}

    /* 预览层 */
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,6,23,.9);backdrop-filter:blur(4px);z-index:50}
    .lightbox.open{display:flex}
    .lb-inner{max-width:95vw;max-height:95vh;position:relative;display:flex;flex-direction:column;align-items:center;}
    .lb-img-container{position:relative;display:flex;align-items:center;justify-content:center;}
    .lb-img{max-width:90vw;max-height:80vh;border-radius:16px;box-shadow:var(--shadow)}
    .lb-cap{color:#e5e7eb;text-align:center;margin-top:10px;font-size:14px;max-width:600px;padding:0 20px;}
    .lb-close{position:absolute;top:20px;right:20px;}
    .lb-nav{position: absolute;display:flex;justify-content:space-between;width:100%;top:50%;transform:translateY(-50%);pointer-events:none;}
    .lb-nav button{pointer-events:auto;}
    .icon-btn{background:rgba(15,23,42,.7);border:1px solid var(--ring);color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px;margin:0 20px;}

    @media (max-width:640px){
      .brand h1{font-size:34px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
      .icon-btn{padding:10px 12px;margin:0 10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero" aria-label="页头">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Alarm图集</h1>
      </div>
      <div class="sub">自动按 <code>category</code> 分类｜从 <strong>photos.json</strong> 读取（支持多种 JSON 结构）</div>

      <div class="controls" role="region" aria-label="工具栏">
        <div class="input" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          <input id="q" placeholder="搜索标题 / 分类…" autocomplete="off" />
        </div>
        <label class="file-btn">选择你自己的本地 JSON
          <input id="file" type="file" accept="application/json,.json" hidden>
        </label>
        <button class="btn" id="export">导出当前JSON</button>
        <button class="theme-toggle" id="themeToggle" aria-label="切换主题">🌓</button>
      </div>

      <div class="chips" id="chips" aria-label="分类"></div>
      <div class="banner" id="banner">未能通过 <code>fetch('photos.json')</code> 读取数据。若在本地直接用 <code>file://</code> 打开，将被浏览器拦截。解决：① 使用本地服务器（如 VSCode Live Server / <code>python -m http.server</code>）；或 ② 点击"选择本地 JSON"手动加载；或 ③ 部署到静态托管（如 Cloudflare Pages）。</div>
    </header>

    <main>
      <section class="grid" id="grid" aria-live="polite"></section>
    </main>
  </div>

  <!-- 预览 -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <div class="lb-inner">
      <div class="lb-close">
        <button class="icon-btn" id="close" aria-label="关闭">✕</button>
      </div>
      <div class="lb-img-container">
        <div class="lb-nav">
          <button class="icon-btn" id="prev" aria-label="上一张">◀</button>
          <button class="icon-btn" id="next" aria-label="下一张">▶</button>
        </div>
        <img id="lbImg" class="lb-img" alt="预览图" />
      </div>
      <div id="lbCap" class="lb-cap"></div>
    </div>
  </div>

  <script>
    // ---------------- 主题切换功能 ----------------
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    let currentTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      currentTheme = theme;
    }
    
    // 初始化主题
    setTheme(currentTheme);
    
    themeToggle.addEventListener('click', () => {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    // ---------------- 数据加载与标准化 ----------------
    /**
     * 目标标准结构：
     * [ { category: string, photos: [{ url, caption }] } ]
     * 兼容以下输入：
     *  1) 与目标相同结构
     *  2) 扁平数组：[{category, url|avatar|src, caption|name|title}]
     *  3) 单对象：{category, avatar|url, name|caption}
     */
    function normalize(input){
      if(!input) return [];

      // 如果是单对象
      if(!Array.isArray(input)){
        const url = input.url || input.avatar || input.src;
        const caption = input.caption || input.name || input.title || '';
        const category = input.category || '未分类';
        return [{ category, photos: [{ url, caption }] }];
      }

      // 如果是数组且每项含 photos 数组
      if(Array.isArray(input) && input.length && input[0] && Array.isArray(input[0].photos)){
        // 简单校验 url
        return input.map(g => ({
          category: g.category || g.title || '未分类',
          photos: (g.photos||[]).map(p=>({ url: p.url || p.avatar || p.src, caption: p.caption || p.name || p.title || '' }))
        }));
      }

      // 如果是扁平数组
      if(Array.isArray(input)){
        const map = new Map();
        for(const item of input){
          const url = item.url || item.avatar || item.src;
          if(!url) continue;
          const caption = item.caption || item.name || item.title || '';
          const category = item.category || '未分类';
          if(!map.has(category)) map.set(category, []);
          map.get(category).push({ url, caption });
        }
        return [...map.entries()].map(([category, photos])=>({category, photos}));
      }
      return [];
    }

    // 旧页面数据（作为兜底 & 导出示例）
    const OLD_PHOTO_GROUPS = [
      { title: "雨水", photos: [
        { url: "https://i.imgs.ovh/2025/04/29/r7Sux.png", caption: "垂钓" },
        { url: "https://placekitten.com/406/300", caption: "小猫1" },
        { url: "https://placekitten.com/407/300", caption: "小猫2" }
      ]},
      { title: "第一人称", photos: [
        { url: "https://i.imgs.ovh/2025/05/29/TxhIr.png", caption: "1" },
        { url: "https://i.imgs.ovh/2025/05/29/TxI9M.png", caption: "2" }
      ]}
    ];

    function oldToStandard(groups){
      return groups.map(g=>({ category: g.category || g.title || '未分类', photos: g.photos.map(p=>({url:p.url, caption:p.caption||''})) }));
    }

    // ---------------- 渲染与交互 ----------------
    const state = {
      data: [],            // 标准化后的数据（所有分类）
      flat: [],            // 扁平化后的所有图片项 {url, caption, category}
      filterCat: '全部',   // 当前分类
      q: '',               // 搜索词
      visible: []          // 当前渲染顺序（用于预览导航）
    };

    const els = {
      banner: document.getElementById('banner'),
      chips: document.getElementById('chips'),
      grid: document.getElementById('grid'),
      q: document.getElementById('q'),
      file: document.getElementById('file'),
      exportBtn: document.getElementById('export'),
      lb: document.getElementById('lightbox'),
      lbImg: document.getElementById('lbImg'),
      lbCap: document.getElementById('lbCap'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      close: document.getElementById('close')
    };

    async function tryFetchJson(){
      try{
        const res = await fetch('photos.json?ts=' + Date.now());
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        return json;
      }catch(e){
        els.banner.style.display = 'block';
        return null;
      }
    }

    function buildFlat(data){
      const flat = [];
      for(const g of data){
        for(const p of g.photos){
          if(!p || !p.url) continue;
          flat.push({ url: p.url, caption: p.caption || '', category: g.category });
        }
      }
      return flat;
    }

    function uniqueCats(data){
      const set = new Set();
      data.forEach(g=> set.add(g.category||'未分类'));
      return ['全部', ...[...set].sort((a,b)=>a.localeCompare(b,'zh'))];
    }

    function renderChips(){
      els.chips.innerHTML = '';
      for(const cat of uniqueCats(state.data)){
        const b = document.createElement('button');
        b.className = 'chip' + (cat === state.filterCat ? ' active': '');
        b.textContent = cat;
        b.onclick = ()=>{ state.filterCat = cat; renderGrid(); renderChips(); };
        els.chips.appendChild(b);
      }
    }

    // 图片懒加载（IntersectionObserver）
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const img = entry.target; img.src = img.dataset.src; io.unobserve(img);
        }
      })
    }, { rootMargin: '200px' });

    function renderGrid(){
      const q = state.q.trim().toLowerCase();
      const list = state.flat.filter(item=>{
        const passCat = state.filterCat === '全部' || item.category === state.filterCat;
        const passQ = !q || (item.caption && item.caption.toLowerCase().includes(q)) || (item.category && item.category.toLowerCase().includes(q));
        return passCat && passQ;
      });
      state.visible = list; // 记录当前顺序
      els.grid.innerHTML='';
      for(const [i,item] of list.entries()){
        const card = document.createElement('article');
        card.className = 'card'; card.setAttribute('tabindex','0');
        const thumb = document.createElement('div'); thumb.className = 'thumb';
        const img = document.createElement('img'); img.alt = item.caption || '壁纸'; img.loading = 'lazy'; img.decoding='async'; img.dataset.src = item.url; io.observe(img);
        thumb.appendChild(img);
        const cap = document.createElement('div'); cap.className = 'cap'; cap.textContent = item.caption || item.category || '';
        card.appendChild(thumb); card.appendChild(cap);
        card.onclick = ()=> openLightbox(i);
        card.onkeydown = (e)=>{ if(e.key==='Enter') openLightbox(i); };
        els.grid.appendChild(card);
      }
    }

    function openLightbox(idx){
      const it = state.visible[idx]; if(!it) return;
      els.lb.classList.add('open');
      els.lbImg.src = it.url; els.lbCap.textContent = it.caption || '';
      els.lb.dataset.idx = String(idx);
    }
    function closeLightbox(){ els.lb.classList.remove('open'); els.lbImg.src=''; }
    function nav(delta){
      const idx = Number(els.lb.dataset.idx||0) + delta;
      if(idx<0 || idx>=state.visible.length) return;
      els.lb.dataset.idx = String(idx);
      const it = state.visible[idx];
      els.lbImg.src = it.url; els.lbCap.textContent = it.caption || '';
    }

    // 事件绑定
    els.q.addEventListener('input', ()=>{ state.q = els.q.value; renderGrid(); });
    els.file.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{ try{ const json = JSON.parse(fr.result); applyData(json); } catch(err){ alert('JSON 解析失败'); } };
      fr.readAsText(file);
    });
    els.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'photos.json'; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });

    // Lightbox 控制
    els.close.onclick = closeLightbox;
    els.prev.onclick = ()=> nav(-1);
    els.next.onclick = ()=> nav(1);
    document.addEventListener('keydown', (e)=>{
      if(!document.getElementById('lightbox').classList.contains('open')) return;
      if(e.key==='Escape') closeLightbox();
      if(e.key==='ArrowLeft') nav(-1);
      if(e.key==='ArrowRight') nav(1);
    });
    document.getElementById('lightbox').addEventListener('click', (e)=>{ if(e.target.id==='lightbox') closeLightbox(); });

    function applyData(raw){
      const norm = normalize(raw);
      state.data = norm;
      state.flat = buildFlat(state.data);
      state.filterCat = '全部'; state.q='';
      renderChips(); renderGrid();
    }

    // 启动：优先读取 photos.json，失败则回退到旧数据
    (async function init(){
      const json = await tryFetchJson();
      if(json){ applyData(json); }
      else{ applyData(oldToStandard(OLD_PHOTO_GROUPS)); }
    })();
  </script>
</body>
</html>