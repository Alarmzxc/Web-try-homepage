<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alarmå›¾é›†</title>
  <link rel="icon" href="./image/favicon.ico" />
  <style>
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #60a5fa;
      --primary-2: #a78bfa;
      --ring: rgba(148,163,184,.35);
      --shadow: 0 10px 30px rgba(2,6,23,.35);
      --radius: 16px;
    }
    [data-theme="light"] .brand h1 {
      background: linear-gradient(135deg, #1e293b 0%, #334155 30%, #475569 65%, #64748b 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    [data-theme="light"] {
      --bg: #f1f5f9;
      --card: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --primary: #3b82f6;
      --primary-2: #8b5cf6;
      --ring: rgba(148,163,184,.2);
      --shadow: 0 10px 30px rgba(2,6,23,.1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html {
      height: 100%;
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(96,165,250,.18), transparent 70%),
        radial-gradient(900px 600px at 90% 20%, rgba(167,139,250,.15), transparent 70%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
    }

    body {
      min-height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", sans-serif;
      color: var(--text);
      background: transparent; /* è®© html çš„èƒŒæ™¯é€å‡º */
      transition: color 0.3s ease;
    }

    .container{max-width:1200px;margin:0 auto;padding:24px 20px 60px}

    /* é¡¶éƒ¨è‹±é›„åŒº */
    header.hero{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      margin:0 0 12px 0;
      padding:12px 0 8px 0;
      min-height:22vh;         /* çº¦ä¸ºé¡µé¢é«˜åº¦çš„1/4 */
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{
      width:32px;
      height:32px;
      border-radius:8px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      box-shadow:var(--shadow)
    }
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:1px;
      line-height:1.1;
      background:linear-gradient(135deg,#fff 0%, #dbeafe 30%, #e9d5ff 65%, #fff 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }

    /* æ§ä»¶åŒº */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .controls-row {
      display: flex;
      flex-direction: row;
      gap: 10px;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 800px; /* å¢åŠ æœ€å¤§å®½åº¦ï¼Œä¿è¯æœç´¢æ¡†æœ‰ç©ºé—´åŠ é•¿ */
    }
    .file-btn {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      justify-self: center;
    }
    .btn {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      justify-self: center;
    }
    .input {
      flex: 1 1 0;
      min-width: 300px;
      max-width: 700px; /* ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ */
      margin-right: 10px;
      padding: 6px 10px;
      border-radius: 8px;
      background:rgba(15,23,42,.7);
      border:1px solid var(--ring);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    [data-theme="light"] .input {
      background:rgba(255,255,255,.7);
    }
    .input input{all:unset;color:var(--text);width:100%;font-size:14px}
    .btn, .file-btn{
      appearance:none;border:none;cursor:pointer;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      background:linear-gradient(135deg, rgba(96,165,250,.15), rgba(167,139,250,.15));
      color:var(--text);border:1px solid var(--ring);
      transition:transform .15s ease, background .2s ease, box-shadow .2s ease;
    }
    .btn:hover,.file-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:active,.file-btn:active{transform:translateY(0)}
    
    /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,.7);
      border: 1px solid var(--ring);
      color: var(--text);
    }
    [data-theme="light"] .theme-toggle {
      background: rgba(255,255,255,.7);
    }

    /* åˆ†ç±»chips */
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:2px;
    }
    .chip{
      padding:8px 12px;
      font-size:13px;
      border-radius:6px; /* åœ†è§’æ”¹ä¸º6px */
      border:1px solid var(--ring);
      color:var(--muted);
      background:rgba(15,23,42,.6);
      cursor:pointer;
      user-select:none;
    }
    [data-theme="light"] .chip {
      background: rgba(255,255,255,.6);
      color: var(--muted);
    }
    .chip.active{
      background:linear-gradient(135deg, rgba(96,165,250,.25), rgba(167,139,250,.25));
      border-color:rgba(99,102,241,.5);
      color:#fff;
    }

    /* æç¤º/å‘Šè­¦ */
    .banner{
      display:none;
      margin:14px auto 0;
      max-width:860px;
      padding:8px 10px;
      border-radius:8px;
      border:1px dashed rgba(248,113,113,.5);
      background:rgba(239,68,68,.1);
      color:#fecaca;
      font-size:12px;
      margin-top:8px;
    }

    /* ç½‘æ ¼ */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));gap:20px;margin-top:22px}
    .card{position:relative;background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .thumb{width:100%;height:0;padding-bottom:62%; /* 16:10 */ display:block;position:relative;background:#111}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05);transition:transform .35s ease}
    .card:hover .thumb img{transform:scale(1.06)}
    .cap{position:relative;padding:12px;color:var(--text);font-size:14px;background:var(--card);border-top:1px solid var(--ring)}

    /* é¢„è§ˆå±‚ */
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,6,23,.9);backdrop-filter:blur(4px);z-index:50}
    [data-theme="light"] .lightbox { background: rgba(241,245,249,0.95); }
    .lightbox.open{display:flex}
    .lb-inner{max-width:95vw;max-height:95vh;position:relative;display:flex;flex-direction:column;align-items:center;}
    .lb-img-container{position:relative;display:flex;align-items:center;justify-content:center;}
    .lb-img{max-width:90vw;max-height:80vh;border-radius:16px;box-shadow:var(--shadow)}
    .lb-cap{color:#e5e7eb;text-align:center;margin-top:10px;font-size:14px;max-width:600px;padding:0 20px;}
    [data-theme="light"] .lb-cap { color: #1e293b; }
    .lb-close{position:absolute;top:20px;right:20px;}
    /* ä¿®æ”¹å¯¼èˆªæŒ‰é’®å¸ƒå±€ï¼šç§»åˆ°å›¾ç‰‡å®¹å™¨å¤–éƒ¨ï¼Œå·¦å³ä¸¤ä¾§å‚ç›´å±…ä¸­ */
    .lb-nav{
      position: absolute;
      top: 50%;
      left: -70px; /* å·¦ä¾§å¤–éƒ¨ */
      right: auto;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      pointer-events: none;
    }
    .lb-nav.right{
      left: auto;
      right: -70px; /* å³ä¾§å¤–éƒ¨ */
    }
    .lb-nav button{pointer-events:auto;}
    .icon-btn{background:rgba(15,23,42,.7);border:1px solid var(--ring);color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-size:16px;margin:0;}
    [data-theme="light"] .icon-btn { background: rgba(255,255,255,.7); color: #1e293b; }
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width:640px){
      .brand h1{font-size:34px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
      .icon-btn{padding:10px 12px;margin:0 10px;}
      .lb-nav, .lb-nav.right { left: 0; right: 0; flex-direction: row; gap: 0; top: auto; bottom: -50px; transform: none; justify-content: space-between; width: 100%; }
    }

    /* åˆ†é¡µæ ·å¼ */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 32px 0 0 0;
      font-size: 1.5em;
      background: rgba(15,23,42,0.12);
      border-radius: 16px;
      padding: 12px 0;
      box-shadow: 0 2px 12px rgba(2,6,23,0.08);
    }
    [data-theme="light"] .pagination {
      background: rgba(255,255,255,0.7);
      box-shadow: 0 2px 12px rgba(96,165,250,0.08);
    }

    .page-btn {
      min-width: 40px;
      height: 40px;
      font-size: 0.8em;
      border-radius: 8px;
      border: 1px solid var(--ring);
      background: linear-gradient(135deg, #312e81 0%, #6366f1 100%);
      color: #fff;
      cursor: pointer;
      transition: background .2s, color .2s, border .2s;
      font-family: "SimSun", "å®‹ä½“", serif;
    }
    .page-btn:hover:not([disabled]) {
      background: linear-gradient(135deg, #4338ca 0%, #818cf8 100%);
      color: #fff;
      border-color: #6366f1;
    }
    .page-btn[disabled] {
      background: linear-gradient(135deg, #6366f1 0%, #312e81 100%);
      color: #fff;
      cursor: default;
      font-weight: bold;
      border-color: #6366f1;
    }
    [data-theme="light"] .page-btn {
      background: linear-gradient(135deg, #e0e7ff 0%, #bae6fd 100%);
      color: #2563eb;
      border: 1px solid #93c5fd;
    }
    [data-theme="light"] .page-btn:hover:not([disabled]) {
      background: linear-gradient(135deg, #bae6fd 0%, #e0e7ff 100%);
      color: #2563eb;
      border-color: #60a5fa;
    }
    [data-theme="light"] .page-btn[disabled] {
      background: linear-gradient(135deg, #93c5fd 0%, #e0e7ff 100%);
      color: #2563eb;
      border-color: #93c5fd;
    }

    .ellipsis {
      padding: 0 8px;
      color: var(--muted);
      font-size: 1em;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero" aria-label="é¡µå¤´">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Alarmå›¾é›†</h1>
      </div>
      <div class="sub">è‡ªåŠ¨æŒ‰ <code>category</code> åˆ†ç±»ï½œä» <strong><a href="./photos.json">photos.json</a></strong> è¯»å–ï¼ˆæ”¯æŒå¤šç§ JSON ç»“æ„ï¼‰</div>

      <div class="controls" role="region" aria-label="å·¥å…·æ ">
        <div class="controls-row">
          <label class="file-btn">é€‰æ‹©ä½ è‡ªå·±çš„æœ¬åœ° JSON
            <input id="file" type="file" accept="application/json,.json" hidden>
          </label>
          <button class="btn" id="export">å¯¼å‡ºå½“å‰JSON</button>
        </div>
        <div class="controls-row">
          <div class="input" role="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            <input id="q" placeholder="æœç´¢æ ‡é¢˜ / åˆ†ç±»â€¦" autocomplete="off" />
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
        </div>
      </div>

      <div class="chips" id="chips" aria-label="åˆ†ç±»"></div>
      <div class="banner" id="banner">æœªèƒ½é€šè¿‡ <code>fetch('photos.json')</code> è¯»å–æ•°æ®ã€‚è‹¥åœ¨æœ¬åœ°ç›´æ¥ç”¨ <code>file://</code> æ‰“å¼€ï¼Œå°†è¢«æµè§ˆå™¨æ‹¦æˆªã€‚è§£å†³ï¼šâ‘  ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆå¦‚ VSCode Live Server / <code>python -m http.server</code>ï¼‰ï¼›æˆ– â‘¡ ç‚¹å‡»"é€‰æ‹©æœ¬åœ° JSON"æ‰‹åŠ¨åŠ è½½ï¼›æˆ– â‘¢ éƒ¨ç½²åˆ°é™æ€æ‰˜ç®¡ï¼ˆå¦‚ Cloudflare Pagesï¼‰ã€‚</div>
    </header>

    <main>
      <section class="grid" id="grid" aria-live="polite"></section>
    </main>
  </div>

  <!-- é¢„è§ˆ -->
  <div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
    <div class="lb-inner">
      <div class="lb-close">
        <button class="icon-btn" id="close" aria-label="å…³é—­">âœ•</button>
      </div>
      <div class="lb-nav">
        <button class="icon-btn" id="prev" aria-label="ä¸Šä¸€å¼ ">â—€</button>
      </div>
      <div class="lb-img-container">
        <img id="lbImg" class="lb-img" alt="é¢„è§ˆå›¾" />
      </div>
      <div class="lb-nav right">
        <button class="icon-btn" id="next" aria-label="ä¸‹ä¸€å¼ ">â–¶</button>
      </div>
      <div id="lbCap" class="lb-cap"></div>
    </div>
  </div>

  <script>
    // ---------------- ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ----------------
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    let currentTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      currentTheme = theme;
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜
    setTheme(currentTheme);
    
    themeToggle.addEventListener('click', () => {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    // ---------------- æ•°æ®åŠ è½½ä¸æ ‡å‡†åŒ– ----------------
    /**
     * ç›®æ ‡æ ‡å‡†ç»“æ„ï¼š
     * [ { category: string, photos: [{ url, caption }] } ]
     * å…¼å®¹ä»¥ä¸‹è¾“å…¥ï¼š
     *  1) ä¸ç›®æ ‡ç›¸åŒç»“æ„
     *  2) æ‰å¹³æ•°ç»„ï¼š[{category, url|avatar|src, caption|name|title}]
     *  3) å•å¯¹è±¡ï¼š{category, avatar|url, name|caption}
     */
    function normalize(input){
      if(!input) return [];

      // å¦‚æœæ˜¯å•å¯¹è±¡
      if(!Array.isArray(input)){
        const url = input.url || input.avatar || input.src;
        const caption = input.caption || input.name || input.title || '';
        const category = input.category || 'æœªåˆ†ç±»';
        return [{ category, photos: [{ url, caption }] }];
      }

      // å¦‚æœæ˜¯æ•°ç»„ä¸”æ¯é¡¹å« photos æ•°ç»„
      if(Array.isArray(input) && input.length && input[0] && Array.isArray(input[0].photos)){
        // ç®€å•æ ¡éªŒ url
        return input.map(g => ({
          category: g.category || g.title || 'æœªåˆ†ç±»',
          photos: (g.photos||[]).map(p=>({ url: p.url || p.avatar || p.src, caption: p.caption || p.name || p.title || '' }))
        }));
      }

      // å¦‚æœæ˜¯æ‰å¹³æ•°ç»„
      if(Array.isArray(input)){
        const map = new Map();
        for(const item of input){
          const url = item.url || item.avatar || item.src;
          if(!url) continue;
          const caption = item.caption || item.name || item.title || '';
          const category = item.category || 'æœªåˆ†ç±»';
          if(!map.has(category)) map.set(category, []);
          map.get(category).push({ url, caption });
        }
        return [...map.entries()].map(([category, photos])=>({category, photos}));
      }
      return [];
    }

    // æ—§é¡µé¢æ•°æ®ï¼ˆä½œä¸ºå…œåº• & å¯¼å‡ºç¤ºä¾‹ï¼‰
    const OLD_PHOTO_GROUPS = [
      { title: "é›¨æ°´", photos: [
        { url: "https://i.imgs.ovh/2025/04/29/r7Sux.png", caption: "å‚é’“" },
        { url: "https://placekitten.com/406/300", caption: "å°çŒ«1" },
        { url: "https://placekitten.com/407/300", caption: "å°çŒ«2" }
      ]},
      { title: "ç¬¬ä¸€äººç§°", photos: [
        { url: "https://i.imgs.ovh/2025/05/29/TxhIr.png", caption: "1" },
        { url: "https://i.imgs.ovh/2025/05/29/TxI9M.png", caption: "2" }
      ]}
    ];

    function oldToStandard(groups){
      return groups.map(g=>({ category: g.category || g.title || 'æœªåˆ†ç±»', photos: g.photos.map(p=>({url:p.url, caption:p.caption||''})) }));
    }

    // ---------------- æ¸²æŸ“ä¸äº¤äº’ ----------------
    const state = {
      data: [],            // æ ‡å‡†åŒ–åçš„æ•°æ®ï¼ˆæ‰€æœ‰åˆ†ç±»ï¼‰
      flat: [],            // æ‰å¹³åŒ–åçš„æ‰€æœ‰å›¾ç‰‡é¡¹ {url, caption, category}
      filterCat: 'å…¨éƒ¨',   // å½“å‰åˆ†ç±»
      q: '',               // æœç´¢è¯
      visible: [],          // å½“å‰æ¸²æŸ“é¡ºåºï¼ˆç”¨äºé¢„è§ˆå¯¼èˆªï¼‰
      page: 1              // å½“å‰é¡µç 
    };

    const els = {
      banner: document.getElementById('banner'),
      chips: document.getElementById('chips'),
      grid: document.getElementById('grid'),
      q: document.getElementById('q'),
      file: document.getElementById('file'),
      exportBtn: document.getElementById('export'),
      lb: document.getElementById('lightbox'),
      lbImg: document.getElementById('lbImg'),
      lbCap: document.getElementById('lbCap'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      close: document.getElementById('close')
    };

    async function tryFetchJson(){
      try{
        const res = await fetch('photos.json?ts=' + Date.now());
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        return json;
      }catch(e){
        els.banner.style.display = 'block';
        return null;
      }
    }

    function buildFlat(data){
      const flat = [];
      for(const g of data){
        for(const p of g.photos){
          if(!p || !p.url) continue;
          flat.push({ url: p.url, caption: p.caption || '', category: g.category });
        }
      }
      return flat;
    }

    function uniqueCats(data){
      const set = new Set();
      data.forEach(g=> set.add(g.category||'æœªåˆ†ç±»'));
      return ['å…¨éƒ¨', ...[...set].sort((a,b)=>a.localeCompare(b,'zh'))];
    }

    function renderChips(){
      els.chips.innerHTML = '';
      for(const cat of uniqueCats(state.data)){
        const b = document.createElement('button');
        b.className = 'chip' + (cat === state.filterCat ? ' active': '');
        b.textContent = cat;
        b.onclick = ()=>{ state.filterCat = cat; renderGrid(); renderChips(); };
        els.chips.appendChild(b);
      }
    }

    // å›¾ç‰‡æ‡’åŠ è½½ï¼ˆIntersectionObserverï¼‰
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const img = entry.target; img.src = img.dataset.src; io.unobserve(img);
        }
      })
    }, { rootMargin: '200px' });

    const PAGE_SIZE = 20;
    state.page = 1;

    function renderGrid(){
      const q = state.q.trim().toLowerCase();
      const shuffled = [...state.flat].sort(() => Math.random() - 0.5);
      const list = shuffled.filter(item=>{
        const passCat = state.filterCat === 'å…¨éƒ¨' || item.category === state.filterCat;
        const passQ = !q || (item.caption && item.caption.toLowerCase().includes(q)) || (item.category && item.category.toLowerCase().includes(q));
        return passCat && passQ;
      });
      state.visible = list;
      // åˆ†é¡µ
      const start = (state.page - 1) * PAGE_SIZE;
      const pageItems = list.slice(start, start + PAGE_SIZE);
      els.grid.innerHTML='';
      for(const [i,item] of pageItems.entries()){
        const card = document.createElement('article');
        card.className = 'card'; card.setAttribute('tabindex','0');
        const thumb = document.createElement('div'); thumb.className = 'thumb';
        const img = document.createElement('img'); img.alt = item.caption || 'å£çº¸'; img.loading = 'lazy'; img.decoding='async'; img.dataset.src = item.url; io.observe(img);
        thumb.appendChild(img);
        const cap = document.createElement('div'); cap.className = 'cap'; cap.textContent = item.caption || item.category || '';
        card.appendChild(thumb); card.appendChild(cap);
        card.onclick = ()=> openLightbox(i);
        card.onkeydown = (e)=>{ if(e.key==='Enter') openLightbox(i); };
        els.grid.appendChild(card);
      }
      renderPagination(list.length);
    }

    function renderPagination(total){
      const totalPages = Math.ceil(total / PAGE_SIZE);
      let html = '';

      // ä¸Šä¸€é¡µæŒ‰é’®
      html += `<button class="page-btn" ${state.page===1?'disabled':''} data-page="${state.page-1}">ä¸Šä¸€é¡µ</button>`;

      // é¡µç æ˜¾ç¤ºé€»è¾‘
      if (totalPages <= 7) {
        // é¡µç å°‘æ—¶å…¨éƒ¨æ˜¾ç¤º
        for(let i=1;i<=totalPages;i++){
          html += `<button class="page-btn" ${i===state.page?'disabled':''} data-page="${i}">${i}</button>`;
        }
      } else {
        // é¡µç å¤šæ—¶æ˜¾ç¤ºéƒ¨åˆ†ï¼Œçœç•¥å·éšè—ä¸­é—´é¡µç 
        if (state.page > 3) {
          html += `<button class="page-btn" data-page="1">1</button>`;
          if (state.page > 4) html += `<span class="ellipsis">...</span>`;
        }
        // å½“å‰é¡µå‰åå„æ˜¾ç¤º2ä¸ª
        let start = Math.max(2, state.page - 2);
        let end = Math.min(totalPages - 1, state.page + 2);
        for(let i=start;i<=end;i++){
          html += `<button class="page-btn" ${i===state.page?'disabled':''} data-page="${i}">${i}</button>`;
        }
        if (state.page < totalPages - 2) {
          if (state.page < totalPages - 3) html += `<span class="ellipsis">...</span>`;
          html += `<button class="page-btn" data-page="${totalPages}">${totalPages}</button>`;
        }
      }

      // ä¸‹ä¸€é¡µæŒ‰é’®
      html += `<button class="page-btn" ${state.page===totalPages?'disabled':''} data-page="${state.page+1}">ä¸‹ä¸€é¡µ</button>`;

      if(!els.pagination){
        els.pagination = document.createElement('div');
        els.pagination.className = 'pagination';
        els.grid.parentNode.appendChild(els.pagination);
      }
      els.pagination.innerHTML = html;
      els.pagination.onclick = e=>{
        if(e.target.dataset.page){
          const page = Number(e.target.dataset.page);
          if(page >= 1 && page <= totalPages && page !== state.page){
            state.page = page;
            renderGrid();
          }
        }
      };
    }

    function openLightbox(idx){
      const it = state.visible[idx]; if(!it) return;
      els.lb.classList.add('open');
      els.lbImg.src = it.url; els.lbCap.textContent = it.caption || '';
      els.lb.dataset.idx = String(idx);
    }
    function closeLightbox(){ els.lb.classList.remove('open'); els.lbImg.src=''; }
    function nav(delta){
      const idx = Number(els.lb.dataset.idx||0) + delta;
      if(idx<0 || idx>=state.visible.length) return;
      els.lb.dataset.idx = String(idx);
      const it = state.visible[idx];
      els.lbImg.src = it.url; els.lbCap.textContent = it.caption || '';
    }

    // äº‹ä»¶ç»‘å®š
    els.q.addEventListener('input', ()=>{ state.q = els.q.value; renderGrid(); });
    els.file.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{ try{ const json = JSON.parse(fr.result); applyData(json); } catch(err){ alert('JSON è§£æå¤±è´¥'); } };
      fr.readAsText(file);
    });
    els.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'photos.json'; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });

    // Lightbox æ§åˆ¶
    els.close.onclick = closeLightbox;
    els.prev.onclick = ()=> nav(-1);
    els.next.onclick = ()=> nav(1);
    document.addEventListener('keydown', (e)=>{
      if(!document.getElementById('lightbox').classList.contains('open')) return;
      if(e.key==='Escape') closeLightbox();
      if(e.key==='ArrowLeft') nav(-1);
      if(e.key==='ArrowRight') nav(1);
    });
    document.getElementById('lightbox').addEventListener('click', (e)=>{ if(e.target.id==='lightbox') closeLightbox(); });

    function applyData(raw){
      const norm = normalize(raw);
      state.data = norm;
      state.flat = buildFlat(state.data);
      state.filterCat = 'å…¨éƒ¨'; state.q='';
      renderChips(); renderGrid();
    }

    // å¯åŠ¨ï¼šä¼˜å…ˆè¯»å– photos.jsonï¼Œå¤±è´¥åˆ™å›é€€åˆ°æ—§æ•°æ®
    (async function init(){
      const json = await tryFetchJson();
      if(json){ applyData(json); }
      else{ applyData(oldToStandard(OLD_PHOTO_GROUPS)); }
    })();
  </script>
</body>
</html>